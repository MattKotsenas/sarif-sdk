pr:
- 'main'
parameters:
- name: pools
  type: object
  default:
    - name: 1ES-Shared-Hosted-Pool_Linux-Mariner-2
      os: linux
    - name: 1ES-Shared-Hosted-Pool_Windows-Server-2022
      os: windows
resources:
  repositories:
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
extends:
    template: v1/1ES.Unofficial.PipelineTemplate.yml@1esPipelines

    parameters:
      sdl:
        suppression:
          suppressionFile: $(Build.SourcesDirectory)\guardian\SDL\.gdnsuppress

      stages:
        - stage: Build
          jobs:
            - ${{ each pool in parameters.pools }}:
              - job: ${{ pool.os }}_Build
                pool:
                  name: ${{ pool.name }}
                  os: ${{ pool.os }}

                templateContext:
                  inputs:
                    - input: checkout
                      repository: self
                      submodules: recursive
                  outputs:
                    - output: pipelineArtifact
                      artifactName: Publish msbuild.binlog
                      artifact: 'MsbuildBinLog'
                      targetPath: $(System.DefaultWorkingDirectory)/bld/bin

                steps:
                  - task: PowerShell@2
                    displayName: Build and Test
                    inputs:
                      targetType: filePath
                      filePath: $(System.DefaultWorkingDirectory)/scripts/BuildAndTest.ps1

                  # Build Multitool for npm
                  - task: PowerShell@2
                    displayName: Build Multitool for npm
                    inputs:
                      targetType: filePath
                      filePath: $(System.DefaultWorkingDirectory)/scripts/BuildMultitoolForNpm.ps1
