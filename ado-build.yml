pr:
- 'main'

resources:
  repositories:
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
extends:
    template: v1/1ES.Unofficial.PipelineTemplate.yml@1esPipelines

    parameters:
      sdl:
        suppression:
          suppressionFile: $(Build.SourcesDirectory)\guardian\SDL\.gdnsuppress
        
      stages:
        - stage: Build
          jobs:
            - job: Build
              strategy:
                matrix:
                  linux:
                    poolName: 1ES-Shared-Hosted-Pool_Linux-Mariner-2
                    os: linux
                  windows:
                    poolName: 1ES-Shared-Hosted-Pool_Windows-Server-2022
                    os: windows
                maxParallel: 4
      
              pool:
                name: $(poolName)
              authenticatedContainerRegistries:
                - reistry: onebranch.azurecr.io
                  tenant: AME
                  identity: 1ESPipelineIdentity
              containers:
              ${{ if eq(os, 'windows') }}:
                default_windows_container:
                  image: oneespipelinesvalidation.azurecr.io/windows/servercore:1809
              ${{ elseif eq(os, 'linux') }}:
                default_linux_container:
                  image: onebranch.azurecr.io/linux/ubuntu-2004:latest

              templateContext:
                inputs:
                - input: checkout
                  repository: self
                  submodules: recursive
                outputs:
                  - output: pipelineArtifact
                    targetPath: $(System.DefaultWorkingDirectory)/bld/bin

              steps:
                - task: PowerShell@2
                  displayName: Build and Test
                  inputs:
                    targetType: filePath
                    filePath: $(System.DefaultWorkingDirectory)/scripts/BuildAndTest.ps1

                # Build Multitool for npm
                - task: PowerShell@2
                  displayName: Build Multitool for npm
                  inputs:
                    targetType: filePath
                    filePath: $(System.DefaultWorkingDirectory)/scripts/BuildMultitoolForNpm.ps1

                - publish: 'msbuild.binlog'
                  displayName: Publish msbuild.binlog
                  artifact: 'MsbuildBinLog'
                