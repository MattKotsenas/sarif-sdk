pr:
- 'main'

strategy:
  matrix:
    linux:
      imageName: 'ubuntu-20.04'
    mac:
      imageName: 'macOS-latest'
    windows:
      imageName: 'windows-latest'
  maxParallel: 4

resources:
  repositories:
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
extends:
    template: v1/1ES.Unofficial.PipelineTemplate.yml@1esPipelines
    parameters:
      pool:
        vmImage: $(imageName)      
      
      sdl:
        suppression:
          suppressionFile: $(Build.SourcesDirectory)\guardian\SDL\.gdnsuppress
        
      stages:
        - stage: Build
          jobs:
            - job: Build
              templateContext:
                inputs:
                - input: checkout
                  repository: self
                  submodules: recursive
                outputs:
                  - output: pipelineArtifact
                    targetPath: $(System.DefaultWorkingDirectory)/bld/bin

              steps:
                - task: PowerShell@2
                  displayName: Build and Test
                  inputs:
                    targetType: filePath
                    filePath: $(System.DefaultWorkingDirectory)/scripts/BuildAndTest.ps1

                # Build Multitool for npm
                - task: PowerShell@2
                  displayName: Build Multitool for npm
                  inputs:
                    targetType: filePath
                    filePath: $(System.DefaultWorkingDirectory)/scripts/BuildMultitoolForNpm.ps1

                - publish: 'msbuild.binlog'
                  displayName: Publish msbuild.binlog
                  artifact: 'MsbuildBinLog'
                